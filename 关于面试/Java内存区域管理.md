Java内存

Java虚拟机内存区域

![image-20201207151646521](C:\Users\smallwhite\AppData\Roaming\Typora\typora-user-images\image-20201207151646521.png)

Java虚拟机内存总体上分为两大块，一块是线程共有区域，一块是线程私有区域。

其中线程共有区域包括两块，方法区和堆 ，线程私有区域包括两块，栈和程序计数器。同时栈又包括虚拟机栈和本地方法栈。

所以总体上说，Java虚拟机一共分为四个区域，堆、方法区、栈、程序计数器。

1. 程序计数器，属于线程私有内存

   程序计数器是一块较小的内存空间，它可以看作是当前线程所执行的字节码的行号指示器。也就是该计数器指向当前所执行的程序。再明确一点就是标志当前程序指向的程序。这个是操作系统多线程程序执行的基本保证，这样保证了`cpu` 执行程序的精准轮换。

   不仅如此，字节码解释器的工作就是通过改变这个计数器的值来选取下一条执行的程序，它是程序控制流的指示器，分支、循环、跳转、异常处理、线程挂起、线程恢复全部依赖这个程序计数器。

   如果当前线程正在执行本地方法，那么这个计数器的值为空。

2. Java虚拟机栈，属于线程私有内存

   每个方法被执行的时候，Java 虚拟机会同步创建一个栈帧用于存储局部变量表、操作数栈、动态连接、方法出口等信息。

   这里比较重要的时候局部变量表。局部变量表包括 8 种基本数据类型和 引用类型数据的指针。

   这里又涉及到两个异常

   `StackOverFlowError` 和 `OutOfMemoryError` 异常

   当线程请求的栈帧深度大于所允许的深度，就会抛出 `StackOverFlowError`

   如果Java 虚拟机栈容量可以动态扩展，当栈扩展无法申请到足够的内存就会抛出`OutOfMemoryError` 异常 

3. 本地方法栈 ，属于线程私有内存

   与虚拟机栈类似，只不过虚拟机栈为虚拟机执行Java方法服务，而本地方法栈则是为虚拟机提供本地`Nature` 方法服务。

4. Java堆 ，属于线程共有

   堆是虚拟机内存中占内存最大的一块，这里的作用是存放对象实例

   因为存储大量对象，所以这里是Java垃圾回收器的主要工作区，再者因为现在的垃圾回收算法都是基于`经典分代算法` 来实现的，所以块内存区域会细分为很多区域，老年代，新生代，永久代。

5. 方法区  属于线程共有

   用来存储，已被虚拟机加载的类型信息常量、静态变量、即时编译器编译后的代码缓存等数据。

   永久代，再`JDK8` 以前，Java虚拟机团队使用分代设计的思路来设计方法区，但是这不是一个好主意，因为这经常导致Java内存溢出。到`JDK8`，永久代这个概念被车点移除。

   - 运行时常量池，是方法区的一部分，存放编译器生成的各种字面量和符号引用。



对象创建的过程

```java
class A{
 static int x = 0;
 int a;
 String str;
 public String toString(){}
}
public static void main(String[] args){
    A a = new A();
}
// a存储在虚拟机栈上，但是是一个指针，该指针指向堆中的对象数据
// a 存储在堆中  str 是存储在堆中，但其实也只是一个指针，指针指向方法区中的常量池中的str，toString 方法保存在方法区
//  x 和方法一样都是属于类的，所以存在方法区中
```

局部变量存储在虚拟机栈中

实例变量存储在堆中

静态变量存储在方法区中



堆分为 新生代和老生代 

新生代又分为 `Eden` `s0` `s1` 区 等等，对象创建之后一般会分配在`Eden` 区，大对象会直接进入老年区，经历一次新生代垃圾回收，对象会从`Eden` 区进入`s1` 或 `s0` ,每经历一次垃圾回收算法，`s0` 区的对象年龄就增加一岁，当达到阈值就会进入`s1` 区，当`Eden ` 区的内存不够用的时候，会进行一次新生代垃圾回收，同样老年代内存满了也会进行回收，但是频率较低。





`JVM` 内存分配 必须是线程安全的

- `CAS` + 失败重试
- `TLAB` 为每一个线程预先在`Eden` 分配一块内存，这块内存是`TLAB` ，当这块区域被用完之后然后采用上述操作



如何判断对象是否死亡

- 引用计数法，当一个对象被引用一次，引用计数器加一，引用失效则减一。当计数器为0时，该对象就是不可能再被使用的。
- 可达性分析算法，通过`GCroot` 为起点，从该节点向下搜索，如果找不到，就是被回收了。

